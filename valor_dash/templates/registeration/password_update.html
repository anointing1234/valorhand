{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Valorhand | Reset Password</title>
    <link rel="stylesheet" href="{% static 'vendors/iconfonts/font-awesome/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/css/vendor.bundle.base.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/css/vendor.bundle.addons.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
      .form-control {
        border: none;
        box-shadow: none;
        border: 1px solid black;
      }
      .form-control:focus {
        border-color: black;
        box-shadow: none;
      }
      .bg-image {
        background-image: url("{% static 'images/valor_bg.jpg' %}");
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
      }
      .logo {
        font-family: 'Arial', sans-serif;
        font-size: 48px;
        font-weight: 1000;
        color: black;
        text-transform: uppercase;
        letter-spacing: 5px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        background: linear-gradient(90deg, #f39c12, #e74c3c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 20px 0;
      }
      .card {
        border-radius: 20px;
      }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  
  <body>
    <div class="container-fluid">
      <h5 class="card-title text-dark text-start py-3 me-3 mt-2 fw-bold">VALORHAND | <span>Investment Banking</span></h5>
    </div>
    <div class="container-fluid d-flex justify-content-center mt-2 pt-2 py-5">
      <div class="col-md-4 grid-margin stretch-card">
        <div class="card border-white bg-transparent">
          <div class="card-body">
            <h3 class="text-center text-dark fw-bold mt-2 mb-5">Reset Password</h3>
            
            <!-- Password Reset Form -->
            <form id="ResetPasswordForm" class="forms-sample" method="POST" action="">
              {% csrf_token %}
              <div class="form-group">
                <label for="new_password" class="text-dark mt-4">New Password</label>
                <input type="password" class="form-control" id="new_password" name="new_password" required>
              </div>
              <div class="form-group">
                <label for="confirm_password" class="text-dark mt-4">Confirm Password</label>
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
              </div>
              <button type="submit" class="btn btn-dark col-12 mt-4">Update Password</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
      <div class="container">
        <hr class="my-4 bg-light">
        <div class="text-center">
          <p>
            Valorhand is a business of Valorhand Bank USA, a wholly-owned subsidiary of The Valorhand Group, Inc. Loans and deposit products are provided by Valorhand Bank USA, Salt Lake City branch. Member FDIC.
          </p>
          <p>
            Â©<span id="year"></span> Valorhand. All Rights Reserved. Valorhand is a registered trademark of Valorhand & Co. LLC.<br>
            Norton Secured | Equal-opportunity Lender
          </p>
        </div>
      </div>
    </footer>

    <!-- JS Scripts -->
    <script>
      document.getElementById('year').innerText = new Date().getFullYear();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Password Reset Form Handling -->
    <script>
        $(document).ready(function() {
            // Function to get the CSRF token from the cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Check if this cookie string begins with the name we want
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrfToken = getCookie('csrftoken'); // Get CSRF token from cookies

            $('#ResetPasswordForm').on('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                // Get the token from the URL
                const urlParts = window.location.pathname.split('/');
                const token = urlParts[urlParts.length - 2]; // Adjust this based on your URL structure

                // Serialize form data using FormData API
                const formData = new FormData(this);  // Automatically serializes the form

                // Construct the URL for the AJAX request
                const resetUrl = `/accounts/reset_password/${token}/`; // Construct the correct URL

                // Send AJAX request
                $.ajax({
                    type: "POST",
                    url: resetUrl, // Use the dynamically constructed URL
                    data: formData,  // Send the form data
                    processData: false,  // Required for FormData
                    contentType: false,  // Required for FormData
                    headers: {
                        'X-CSRFToken': csrfToken // Include the CSRF token in the request headers
                    },
                    success: function(response) {
                        // Show success alert
                        Swal.fire({
                            icon: 'success',
                            title: response.message,
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Redirect to the login page after success
                            window.location.href = "{% url 'login' %}";
                        });
                    },
                    error: function(xhr) {
                        // Handle errors
                        const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'An error occurred.';
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMessage,
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
        });
    </script>

  </body>
</html>
